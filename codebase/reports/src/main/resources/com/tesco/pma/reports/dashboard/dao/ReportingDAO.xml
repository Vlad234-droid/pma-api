<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tesco.pma.reports.dashboard.dao.ReportingDAO">

    <resultMap id="objectiveResultMap" type="com.tesco.pma.reports.review.domain.ObjectiveLinkedReviewData">
        <id property="colleagueUUID" column="employee_uuid"/>
        <result property="iamId" column="employee_no"/>
        <result property="firstName" column="first_name"/>
        <result property="lastName" column="surname"/>
        <result property="workLevel" column="working_level"/>
        <result property="jobTitle" column="job_title"/>
        <result property="lineManager" column="line_manager"/>
        <result property="objectiveNumber" column="objective_number"/>
        <result property="status" column="status" typeHandler="com.tesco.pma.dao.utils.DictionaryItemTypeHandler"
                javaType="com.tesco.pma.cycle.api.PMTimelinePointStatus"/>
        <result property="strategicPriority" column="strategic_priority"/>
        <result property="objectiveTitle" column="objective"/>
        <result property="howAchieved" column="how_achieved"/>
        <result property="howOverAchieved" column="how_over_achieved"/>
    </resultMap>

    <resultMap id="colleagueReportTagsResultMap" type="map">
        <result column="is_new_to_business" property="is_new_to_business"/>
        <result column="must_create_objective" property="must_create_objective"/>
        <result column="has_objective_submitted" property="has_objective_submitted"/>
        <result column="has_objective_approved" property="has_objective_approved"/>
        <result column="must_create_myr" property="must_create_myr"/>
        <result column="has_myr_submitted" property="has_myr_submitted"/>
        <result column="has_myr_approved" property="has_myr_approved"/>
        <result column="myr_what_rating" property="myr_what_rating"/>
        <result column="myr_how_rating" property="myr_how_rating"/>
        <result column="must_create_eyr" property="must_create_eyr"/>
        <result column="has_eyr_submitted" property="has_eyr_submitted"/>
        <result column="has_eyr_approved" property="has_eyr_approved"/>
        <result column="eyr_what_rating" property="eyr_what_rating"/>
        <result column="eyr_how_rating" property="eyr_how_rating"/>
        <result column="has_eyr_approved_1_quarter" property="has_eyr_approved_1_quarter"/>
        <result column="has_eyr_approved_2_quarter" property="has_eyr_approved_2_quarter"/>
        <result column="has_eyr_approved_3_quarter" property="has_eyr_approved_3_quarter"/>
        <result column="has_eyr_approved_4_quarter" property="has_eyr_approved_4_quarter"/>
    </resultMap>

    <resultMap id="colleagueReportTargetingResultMap" type="com.tesco.pma.reports.dashboard.domain.ColleagueReportTargeting">
        <id property="uuid" column="uuid"/>
        <result property="firstName" column="first_name"/>
        <result property="lastName" column="last_name"/>
        <result property="jobName" column="job_name"/>
        <result property="businessType" column="business_type"/>
        <association property="tags" resultMap="colleagueReportTagsResultMap"/>
    </resultMap>

    <sql id="getFilterField">
        AND
        <choose>
            <when test="filter.property == 'year'">
                EXTRACT(YEAR FROM pc.start_time)
            </when>
            <when test="filter.property == 'statuses'">
                ptps.code
            </when>
        </choose>
    </sql>

    <sql id="getExpression">
        <choose>
            <when test="filter.operand.name == 'EQUALS' and (filter.property == 'year' or filter.property == 'statuses')">
                <include refid="getFilterField"/>
                = '${filter.value}'
            </when>
            <when test="filter.operand.name == 'IN' and filter.property == 'statuses'">
                <include refid="getFilterField"/>
                IN
                <include refid="prepareValues"/>
            </when>
        </choose>
    </sql>

    <sql id="prepareValues">
        <foreach item="value" collection="filter.value" separator="," open="(" close=")">
            <choose>
                <when test="filter.property == 'statuses'">
                    #{value}
                </when>
            </choose>
        </foreach>
    </sql>

    <select id="getLinkedObjectivesData" resultMap="objectiveResultMap">
        SELECT c1.iam_id as "employee_no",
        c1.uuid as "employee_uuid",
        c1.first_name as "first_name",
        c1.last_name as "surname",
        c1.work_level as "working_level",
        j.name as "job_title",
        c2.first_name||' '||c2.last_name as "line_manager",
        pr.number as "objective_number",
        pr.status_id as "status",
        pr.properties::json ->> 'strategic_priority' as "strategic_priority",
        pr.properties::json ->> 'title' as "objective",
        pr.properties::json ->> 'how_achieved' as "how_achieved",
        pr.properties::json ->> 'how_over_achieved' as "how_over_achieved"
        FROM colleague c1
        LEFT JOIN job j ON c1.job_id = j.id
        LEFT JOIN colleague c2 ON c1.manager_uuid = c2.uuid
        INNER JOIN pm_colleague_cycle pcc ON c1.uuid = pcc.colleague_uuid
        INNER JOIN pm_cycle pc ON pcc.cycle_uuid = pc.uuid
        INNER JOIN pm_timeline_point ptp ON pcc.uuid = ptp.colleague_cycle_uuid
        INNER JOIN pm_review pr ON ptp.uuid = pr.tl_point_uuid
        INNER JOIN pm_tl_point_status ptps ON pr.status_id = ptps.id
        WHERE pr.type_id = 1
        AND c1.work_level IN ('WL4', 'WL5')
        AND pc.type_id = 1

        <if test="!requestQuery.filters.isEmpty()">
            <foreach collection="requestQuery.filters" item="filter" index="index">
                <include refid="getExpression"/>
            </foreach>
        </if>
    </select>

    <select id="getColleagueTargeting" resultMap="colleagueReportTargetingResultMap">
        with filtered_colleague as (
        <include refid="colleagueQuery"/>
        ),
             enriched_colleagues as
                 (
                     select fc.uuid,
                            fc.first_name,
                            fc.last_name,
                            fc.job_name,
                            fc.business_type,
                            fc.is_new_to_business,
                            count(case when upper(ptp.code) = 'OBJECTIVE' then 1 end)                        as objective_cnt,
                            count(
                                    case when upper(ptp.code) = 'OBJECTIVE' and pr.status_id = 2 then 1 end) as objective_submitted_cnt,
                            count(
                                    case when upper(ptp.code) = 'OBJECTIVE' and pr.status_id = 3 then 1 end) as objective_approved_cnt,
                            count(case when upper(ptp.code) = 'MYR' then 1 end)                              as myr_cnt,
                            count(
                                    case when upper(ptp.code) = 'MYR' and pr.status_id = 2 then 1 end)       as myr_submitted_cnt,
                            count(
                                    case when upper(ptp.code) = 'MYR' and pr.status_id = 3 then 1 end)       as myr_approved_cnt,
                            max(case
                                    when upper(ptp.code) = 'MYR'
                                        then (pr.properties::json ->> 'what_rating')::varchar end)            as myr_what_rating,
                            max(case
                                    when upper(ptp.code) = 'MYR'
                                        then (pr.properties::json ->> 'how_rating')::varchar end)             as myr_how_rating,
                            count(case when upper(ptp.code) = 'EYR' then 1 end)                              as eyr_cnt,
                            count(
                                    case when upper(ptp.code) = 'EYR' and pr.status_id = 2 then 1 end)       as eyr_submitted_cnt,
                            count(
                                    case when upper(ptp.code) = 'EYR' and pr.status_id = 3 then 1 end)       as eyr_approved_cnt,
                            max(case
                                    when upper(ptp.code) = 'EYR'
                                        then (pr.properties::json ->> 'what_rating')::varchar end)            as eyr_what_rating,
                            max(case
                                    when upper(ptp.code) = 'EYR'
                                        then (pr.properties::json ->> 'how_rating')::varchar end)             as eyr_how_rating
                     from filtered_colleague fc
                              left join pm_timeline_point ptp
                                        on (ptp.colleague_cycle_uuid = fc.colleague_cycle_uuid)
                              left join pm_review pr
                                        on (pr.tl_point_uuid = ptp.uuid)
                     group by fc.uuid,
                              fc.first_name,
                              fc.last_name,
                              fc.job_name,
                              fc.business_type,
                              fc.is_new_to_business)
        select ec.uuid,
               ec.first_name,
               ec.last_name,
               ec.job_name,
               ec.business_type,
               ec.is_new_to_business,
               case when ec.objective_cnt > 0 then '1' else '0' end as must_create_objective,
               case when ec.objective_submitted_cnt > 0 then '1' else '0' end as has_objective_submitted,
               case when ec.objective_approved_cnt > 0 then '1' else '0' end as has_objective_approved,
               case when ec.myr_cnt > 0 then '1' else '0' end as must_create_myr,
               case when ec.myr_submitted_cnt > 0 then '1' else '0' end as has_myr_submitted,
               case when ec.myr_approved_cnt > 0 then '1' else '0' end as has_myr_approved,
               coalesce(ec.myr_what_rating,'0') as myr_what_rating,
               coalesce(ec.myr_how_rating,'0') as myr_how_rating,
               case when ec.eyr_cnt > 0 then '1' else '0' end as must_create_eyr,
               case when ec.eyr_submitted_cnt > 0 then '1' else '0' end as has_eyr_submitted,
               case when ec.eyr_approved_cnt > 0 then '1' else '0' end as has_eyr_approved,
               coalesce(ec.eyr_what_rating,'0') as eyr_what_rating,
               coalesce(ec.eyr_how_rating,'0') as eyr_how_rating
        from enriched_colleagues ec
    </select>

    <sql id="colleagueQuery">
        select c.uuid,
               c.first_name,
               c.last_name,
               j.name          as job_name,
               d.business_type as business_type,
               pcc.uuid        as colleague_cycle_uuid,
               pc.type_id      as cycle_type_id,
               case
                   when c.hire_date > (now() - interval '90 days')::date
                       then '1'
                   else '0' end as is_new_to_business
        from colleague c
                 inner join pm_colleague_cycle pcc
                            on (pcc.colleague_uuid = c.uuid)
                 inner join pm_cycle pc
                            on (pcc.cycle_uuid = pc.uuid)
                 left join job j
                           on (j.id = c.job_id)
                 left join department d
                           on (d.id = c.department_id)
        where 1 = 1
          and pc.type_id = 1
          and pcc.start_time between make_date(<include refid="getYear"/>, 3, 1) and (make_date(<include refid="getYear"/> + 1, 3, 1) - interval '1 day')::date
          <if test="!requestQuery.filters.isEmpty()">
              <foreach collection="requestQuery.filters" item="filter" index="index">
                  <if test="filter.property != 'year'">
                      <include refid="getExpressionGeneral"/>
                  </if>
              </foreach>
          </if>
    </sql>

    <sql id="getYear">
        <if test="!requestQuery.filters.isEmpty()">
            <foreach collection="requestQuery.filters" item="filter" index="index">
                <choose>
                    <when test="filter.operand.name == 'EQUALS' and filter.property == 'year'">
                        '${filter.value}'::INTEGER
                    </when>
                </choose>
            </foreach>
        </if>
    </sql>

    <select id="getColleagueTargetingAnniversary" resultMap="colleagueReportTargetingResultMap">
        with filtered_colleague as (
            select c.uuid,
                   c.first_name,
                   c.last_name,
                   j.name          as job_name,
                   d.business_type as business_type,
                   pcc.uuid        as colleague_cycle_uuid,
                   pc.type_id      as cycle_type_id
            from colleague c
                     inner join pm_colleague_cycle pcc
                                on (pcc.colleague_uuid = c.uuid)
                     inner join pm_cycle pc
                                on (pcc.cycle_uuid = pc.uuid)
                     left join job j
                               on (j.id = c.job_id)
                     left join department d
                               on (d.id = c.department_id)
            where 1 = 1
              and pc.type_id = 2
              <if test="!requestQuery.filters.isEmpty()">
                  <foreach collection="requestQuery.filters" item="filter" index="index">
                      <if test="filter.property != 'year'">
                          <include refid="getExpressionGeneral"/>
                      </if>
                  </foreach>
              </if>
        ),
             enriched_colleagues as
                 (
                     select fc.uuid,
                            fc.first_name,
                            fc.last_name,
                            fc.job_name,
                            fc.business_type,
                            count(case
                                      when extract(MONTH from pr.last_updated_time) in (3, 4, 5)
                                          then 1 end) as cnt_eyr_approved_1_quarter,
                            count(case
                                      when extract(MONTH from pr.last_updated_time) in (6, 7, 8)
                                          then 1 end) as cnt_eyr_approved_2_quarter,
                            count(case
                                      when extract(MONTH from pr.last_updated_time) in (9, 10, 11)
                                          then 1 end) as cnt_eyr_approved_3_quarter,
                            count(case
                                      when extract(MONTH from pr.last_updated_time) in (12, 1, 2)
                                          then 1 end) as cnt_eyr_approved_4_quarter
                     from filtered_colleague fc
                              inner join pm_timeline_point ptp
                                         on (ptp.colleague_cycle_uuid = fc.colleague_cycle_uuid)
                              inner join pm_review pr
                                         on (pr.tl_point_uuid = ptp.uuid)
                     where 1 = 1
                       and pr.type_id = 3
                       and pr.status_id = 3
                       and pr.last_updated_time between make_date(<include refid="getYear"/>, 3, 1) and (make_date(<include refid="getYear"/> + 1, 3, 1) - interval '1 day')::date
        group by fc.uuid,
            fc.first_name,
            fc.last_name,
            fc.job_name,
            fc.business_type)
        select ec.uuid,
               ec.first_name,
               ec.last_name,
               ec.job_name,
               ec.business_type,
               case when ec.cnt_eyr_approved_1_quarter > 0 then '1' else '0' end as has_eyr_approved_1_quarter,
               case when ec.cnt_eyr_approved_2_quarter > 0 then '1' else '0' end as has_eyr_approved_2_quarter,
               case when ec.cnt_eyr_approved_3_quarter > 0 then '1' else '0' end as has_eyr_approved_3_quarter,
               case when ec.cnt_eyr_approved_4_quarter > 0 then '1' else '0' end as has_eyr_approved_4_quarter
        from enriched_colleagues ec;
    </select>

    <sql id="prepareValuesGeneral">
        <foreach item="value" collection="filter.value" separator="," open="(" close=")">
            <choose>
                <when test="filter.property == 'manager-uuid'">
                    #{value}::uuid
                </when>
                <otherwise>
                    UPPER(#{value})
                </otherwise>
            </choose>
        </foreach>
    </sql>

    <sql id="prepareValueGeneral">
        <choose>
            <when test="filter.property == 'manager-uuid'">
                '${filter.value}'::uuid
            </when>
            <otherwise>
                UPPER('${filter.value}')
            </otherwise>
        </choose>
    </sql>

    <sql id="getExpressionGeneral">
        <choose>
            <when test="filter.operand.name == 'EQUALS'">
                <include refid="getFilterFieldGeneral"/>
                = <include refid="prepareValueGeneral"/>
            </when>
            <when test="filter.operand.name == 'NOT_EQUALS'">
                <include refid="getFilterFieldGeneral"/>
                != <include refid="prepareValueGeneral"/>
            </when>
            <when test="filter.operand.name == 'CONTAINS' and filter.property != 'manager-uuid'">
                <include refid="getFilterFieldGeneral"/>
                LIKE '%'||<include refid="prepareValueGeneral"/>||'%'
            </when>
            <when test="filter.operand.name == 'NOT_CONTAINS' and filter.property != 'manager-uuid'">
                <include refid="getFilterFieldGeneral"/>
                NOT LIKE '%'||<include refid="prepareValueGeneral"/>||'%'
            </when>
            <when test="filter.operand.name == 'IN'">
                <include refid="getFilterFieldGeneral"/>
                IN
                <include refid="prepareValuesGeneral"/>
            </when>
            <when test="filter.operand.name == 'NOT_IN'">
                <include refid="getFilterFieldGeneral"/>
                NOT IN
                <include refid="prepareValuesGeneral"/>
            </when>
            <when test="filter.operand.name == 'NULL'">
                <if test="filter.value == 'true'">
                    <include refid="getFilterFieldGeneral"/>
                    IS NULL
                </if>
                <if test="filter.value == 'false'">
                    <include refid="getFilterFieldGeneral"/>
                    IS NOT NULL
                </if>
            </when>
        </choose>
    </sql>

    <sql id="getFilterFieldGeneral">
        AND
        <choose>
            <when test="filter.property == 'work-level'">
                UPPER(work_level)
            </when>
            <when test="filter.property == 'manager-uuid'">
                manager_uuid
            </when>
            <when test="filter.property == 'department-id'">
                department_id
            </when>
            <when test="filter.property == 'job-id'">
                job_id
            </when>
        </choose>
    </sql>

</mapper>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.2.xsd">


    <changeSet author="ypashynskyi" id="1">
        <createTable tableName="review_status"
                     remarks="Dictionary of review's statuses">
            <column name="id" type="integer"
                    remarks="A unique identifier for status">
                <constraints nullable="false" primaryKey="true" primaryKeyName="review_status_pk"/>
            </column>
            <column name="code" type="VARCHAR(30)"
                    remarks="Shortname of status">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="VARCHAR(100)"
                    remarks="Description of status">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="ypashynskyi" id="2">
        <comment>Init table review_status</comment>
        <insert tableName="review_status">
            <column name="id" value="1"/>
            <column name="code" value="DRAFT"/>
            <column name="description" value="Review is saved as draft"/>
        </insert>
        <insert tableName="review_status">
            <column name="id" value="2"/>
            <column name="code" value="WAITING_FOR_APPROVAL"/>
            <column name="description"
                    value="Review was submitted but not yet approved"/>
        </insert>
        <insert tableName="review_status">
            <column name="id" value="3"/>
            <column name="code" value="APPROVED"/>
            <column name="description" value="Review was approved"/>
        </insert>
        <insert tableName="review_status">
            <column name="id" value="4"/>
            <column name="code" value="DECLINED"/>
            <column name="description" value="Review was declined"/>
        </insert>
        <insert tableName="review_status">
            <column name="id" value="5"/>
            <column name="code" value="COMPLETED"/>
            <column name="description" value="Review is completed"/>
        </insert>
        <insert tableName="review_status">
            <column name="id" value="6"/>
            <column name="code" value="OVERDUE"/>
            <column name="description" value="Review was overdue"/>
        </insert>
        <rollback>
            <delete tableName="review_status">
                <where>code = 'DRAFT'</where>
            </delete>
            <delete tableName="review_status">
                <where>code = 'WAITING_FOR_APPROVAL'</where>
            </delete>
            <delete tableName="review_status">
                <where>code = 'APPROVED'</where>
            </delete>
            <delete tableName="review_status">
                <where>code = 'RETURNED'</where>
            </delete>
            <delete tableName="review_status">
                <where>code = 'COMPLETED'</where>
            </delete>
            <delete tableName="review_status">
                <where>code = 'OVERDUE'</where>
            </delete>
        </rollback>
    </changeSet>

    <changeSet author="ypashynskyi" id="3">
        <createTable tableName="review_type"
                     remarks="Dictionary of review's types">
            <column name="id" type="integer"
                    remarks="A unique identifier for type">
                <constraints nullable="false" primaryKey="true" primaryKeyName="review_type_pk"/>
            </column>
            <column name="code" type="VARCHAR(30)"
                    remarks="Shortname of type">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="VARCHAR(100)"
                    remarks="Description of type">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="ypashynskyi" id="4">
        <comment>Init table review_type</comment>
        <insert tableName="review_type">
            <column name="id" value="1"/>
            <column name="code" value="OBJECTIVE"/>
            <column name="description" value="Objective review"/>
        </insert>
        <insert tableName="review_type">
            <column name="id" value="2"/>
            <column name="code" value="MYR"/>
            <column name="description" value="Mid year review"/>
        </insert>
        <insert tableName="review_type">
            <column name="id" value="3"/>
            <column name="code" value="EYR"/>
            <column name="description" value="End of year review"/>
        </insert>
        <rollback>
            <delete tableName="review_type">
                <where>code = 'OBJECTIVE'</where>
            </delete>
            <delete tableName="review_type">
                <where>code = 'MYR'</where>
            </delete>
            <delete tableName="review_type">
                <where>code = 'EYR'</where>
            </delete>
        </rollback>
    </changeSet>

    <changeSet author="ypashynskyi" id="5">
        <createTable tableName="review"
                     remarks="Table of PMA reviews">
            <column name="uuid" type="${uuid_type}"
                    remarks="A unique identifier for review">
                <constraints nullable="false" primaryKey="true" primaryKeyName="review_pk"/>
            </column>
            <column name="performance_cycle_uuid" type="${uuid_type}"
                    remarks="A unique identifier for performance cycle">
                <constraints nullable="false"/>
            </column>
            <column name="colleague_uuid" type="${uuid_type}"
                    remarks="A unique identifier for every colleague. It is the user id present in Identity.">
                <constraints nullable="false"/>
            </column>
            <column name="type_id" type="integer"
                    remarks="Type of review">
                <constraints nullable="false"/>
            </column>
            <column name="number" type="integer"
                    remarks="A sequence number for colleague's review">
                <constraints nullable="false"/>
            </column>
            <column name="properties" type="jsonb"
                    remarks="Properties of review"/>
            <column name="status_id" type="integer"
                    remarks="Status of review">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="status_id" baseTableName="review"
                                 constraintName="review_status_id_fk" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="review_status"
                                 validate="true"/>
        <addForeignKeyConstraint baseColumnNames="type_id" baseTableName="review"
                                 constraintName="review_type_id_fk" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="review_type"
                                 validate="true"/>
        <addForeignKeyConstraint baseColumnNames="performance_cycle_uuid" baseTableName="review"
                                 constraintName="performance_cycle_uuid_fk" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="uuid" referencedTableName="pm_cycle"
                                 validate="true"/>
        <addUniqueConstraint columnNames="performance_cycle_uuid, colleague_uuid, type_id, number"
                             constraintName="review_unique"
                             tableName="review"/>
    </changeSet>


    <changeSet author="ypashynskyi" id="6">
        <createTable tableName="group_objective_status"
                     remarks="Dictionary of group objective statuses">
            <column name="id" type="integer"
                    remarks="A unique identifier for status">
                <constraints nullable="false" primaryKey="true" primaryKeyName="group_objective_status_pk"/>
            </column>
            <column name="code" type="VARCHAR(30)"
                    remarks="Shortname of status">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="VARCHAR(100)"
                    remarks="Description of status">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="ypashynskyi" id="7">
        <comment>Init table group_objective_status</comment>
        <insert tableName="group_objective_status">
            <column name="id" value="1"/>
            <column name="code" value="DRAFT"/>
            <column name="description" value="Group objective is saved as draft"/>
        </insert>
        <insert tableName="group_objective_status">
            <column name="id" value="2"/>
            <column name="code" value="PUBLISHED"/>
            <column name="description" value="Group objective was published"/>
        </insert>
        <insert tableName="group_objective_status">
            <column name="id" value="3"/>
            <column name="code" value="UNPUBLISHED"/>
            <column name="description" value="Group objective was unpublished"/>
        </insert>
        <rollback>
            <delete tableName="review_status">
                <where>code = 'DRAFT'</where>
            </delete>
            <delete tableName="review_status">
                <where>code = 'PUBLISHED'</where>
            </delete>
            <delete tableName="review_status">
                <where>code = 'UNPUBLISHED'</where>
            </delete>
        </rollback>
    </changeSet>

    <changeSet author="ypashynskyi" id="8">
        <createTable tableName="group_objective"
                     remarks="Table of group(organization, department etc.) objectives">
            <column name="uuid" type="${uuid_type}"
                    remarks="A unique identifier for group objective">
                <constraints nullable="false" primaryKey="true" primaryKeyName="group_objective_pk"/>
            </column>
            <column name="number" type="integer"
                    remarks="A sequence number for business unit's objective">
                <constraints nullable="false"/>
            </column>
            <column name="status_id" type="integer"
                    remarks="Status of review">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="integer"
                    remarks="Version of business unit's objective">
                <constraints nullable="false"/>
            </column>
            <column name="title" type="varchar(50)"
                    remarks="Title of objective">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="status_id" baseTableName="group_objective"
                                 constraintName="group_objective_status_id_fk" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="review_status"
                                 validate="true"/>
        <addUniqueConstraint columnNames="version, number"
                             constraintName="group_objective_unique"
                             tableName="group_objective"/>
    </changeSet>

    <changeSet author="ypashynskyi" id="9">
        <createTable tableName="working_group_objective"
                     remarks="Table for working version of group objective">
            <column name="business_unit_uuid" type="${uuid_type}"
                    remarks="A unique identifier for business unit.">
                <constraints nullable="false" primaryKey="true" primaryKeyName="working_group_objective_pk"/>
            </column>
            <column name="version" type="integer"
                    remarks="Version of business unit's objective">
                <constraints nullable="false"/>
            </column>
            <column name="updated_by" type="VARCHAR(50)"
                    remarks="User who made changes"/>
            <column name="updated_time" type="TIMESTAMPTZ"
                    remarks="Timestamp with zone when changes were applied">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="ypashynskyi" id="10">
        <createTable tableName="review_link"
                     remarks="Table for links from review to group objective">
            <column name="review_uuid" type="${uuid_type}"
                    remarks="A unique identifier for review">
                <constraints nullable="false" primaryKey="true" primaryKeyName="review_link_pk"/>
            </column>
            <column name="group_objective_uuid" type="${uuid_type}"
                    remarks="A unique identifier for group objective">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="review_uuid" baseTableName="review_link"
                                 constraintName="review_link_review_uuid_fk" deferrable="false"
                                 initiallyDeferred="false" onDelete="CASCADE" onUpdate="NO ACTION"
                                 referencedColumnNames="uuid" referencedTableName="review"
                                 validate="true"/>
        <addForeignKeyConstraint baseColumnNames="group_objective_uuid" baseTableName="review_link"
                                 constraintName="review_link_group_objective_uuid_fk" deferrable="false"
                                 initiallyDeferred="false" onDelete="CASCADE" onUpdate="NO ACTION"
                                 referencedColumnNames="uuid" referencedTableName="group_objective"
                                 validate="true"/>
    </changeSet>

    <changeSet author="ypashynskyi" id="11">
        <createTable remarks="History of changing review's statuses"
                     tableName="review_change_status_hi">
            <column name="review_uuid" type="${uuid_type}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="review_change_status_hi_pk"/>
            </column>
            <column name="old_status_id" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="new_status_id" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="change_reason" type="VARCHAR"/>
            <column name="updated_by" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="updated_time" type="TIMESTAMPTZ">
                <constraints nullable="false" primaryKey="true" primaryKeyName="review_change_status_hi_pk"/>
            </column>
        </createTable>
    </changeSet>

</databaseChangeLog>
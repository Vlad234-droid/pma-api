<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tesco.pma.cms.dao.ContentEntryDAO">

    <resultMap id="contentStruct" type="com.tesco.pma.cms.model.ContentEntry">
        <id column="id" property="id"/>
        <result column="key" property="key"/>
        <result column="title" property="title"/>
        <result column="description" property="description"/>
        <result column="image_link" property="imageLink"/>
        <result column="created_by" property="createdBy"/>
        <result column="created_time" property="createdTime"/>
        <result column="version" property="version"/>

        <result property="status" column="status_id" typeHandler="com.tesco.pma.dao.utils.DictionaryItemTypeHandler"
                javaType="com.tesco.pma.cms.model.ContentStatus"/>
    </resultMap>

    <select id="findByKey" resultMap="contentStruct">
        SELECT * FROM cms_content cc WHERE cc.key = #{key} and status_id = ${@com.tesco.pma.cms.model.ContentStatus@PUBLISHED.getId()}
    </select>

    <select id="findById" resultMap="contentStruct">
        SELECT * FROM cms_content cc WHERE cc.id = #{uuid}
    </select>

    <select id="find" resultMap="contentStruct">
        SELECT * FROM cms_content cc

        <where>
            <foreach collection="requestQuery.filters" item="filter" index="index">
                <if test="filter.operand.name == 'EQUALS' and filter.property == 'title'">
                    AND <include refid="getFilterField"/> = '${filter.value}'
                </if>
                <if test="filter.operand.name == 'EQUALS' and filter.property == 'key'">
                    AND <include refid="getFilterField"/> = '${filter.value}'
                </if>
                <if test="filter.operand.name == 'EQUALS' and filter.property == 'status'">
                    AND <include refid="getFilterField"/> = ${@com.tesco.pma.cms.model.ContentStatus@valueOf(filter.value.toUpperCase()).getId()}
                </if>
                <if test="filter.operand.name == 'EQUALS' and filter.property == 'version'">
                    AND <include refid="versionCondition"/>
                </if>
            </foreach>
        </where>

        LIMIT #{requestQuery.limit}

        <if test="requestQuery.offset != null">
            OFFSET #{requestQuery.offset}
        </if>
    </select>

    <sql id="getFilterField">
        <choose>
            <when test="filter.property == 'title'">
                cc.title
            </when>
            <when test="filter.property == 'status'">
                cc.status_id
            </when>
            <when test="filter.property == 'key'">
                cc.key
            </when>
            <otherwise>
                #{filter.property}
            </otherwise>
        </choose>
    </sql>

    <sql id="versionCondition">
        <choose>
            <when test="filter.value == -1">
                cc.version = <include refid="maxVersion"/>
            </when>
            <otherwise>
                cc.version = #{filter.value}
            </otherwise>
        </choose>
    </sql>

    <sql id="maxVersion">
        (SELECT version FROM cms_content cc2 WHERE cc2.title = cc.title ORDER BY version DESC LIMIT 1)
    </sql>

    <insert id="create" flushCache="true" useGeneratedKeys="true" keyProperty="id" keyColumn="id">
        INSERT INTO cms_content (id, key, title, description, image_link, created_by, created_time, version, status_id)
        VALUES (#{content.id}, #{content.key}, #{content.title}, #{content.description},
            #{content.imageLink}, #{content.createdBy}, #{content.createdTime}, #{content.version},
            #{content.status, typeHandler=com.tesco.pma.dao.utils.DictionaryItemTypeHandler,
                javaType=com.tesco.pma.cms.model.ContentStatus})
    </insert>

    <delete id="delete">
        DELETE FROM cms_content WHERE id = #{id}
    </delete>

    <update id="update" flushCache="true">
        UPDATE cms_content cc
        SET key = #{content.key}, title = #{content.title}, description = #{content.description},
            image_link = #{content.imageLink}, created_by = #{content.createdBy}, created_time = #{content.createdTime},
            version = <include refid="maxVersion"/> + 1,
            status_id = #{content.status, typeHandler=com.tesco.pma.dao.utils.DictionaryItemTypeHandler}
        WHERE id = #{content.id}
    </update>



</mapper>
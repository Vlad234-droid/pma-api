<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tesco.pma.fs.dao.TemplateDAO">

    <resultMap id="templateResultMap" type="com.tesco.pma.fs.domain.ProcessTemplate">
        <id property="uuid" column="uuid"/>
        <result property="path" column="path"/>
        <result property="version" column="version"/>
        <result property="type" column="type_id" typeHandler="com.tesco.pma.dao.utils.DictionaryItemTypeHandler" javaType="com.tesco.pma.fs.domain.ProcessTemplateType"/>
        <result property="status" column="status_id" typeHandler="com.tesco.pma.dao.utils.DictionaryItemTypeHandler" javaType="com.tesco.pma.fs.domain.ProcessTemplateStatus"/>
        <result property="description" column="description"/>
        <result property="createdBy" column="created_by"/>
        <result property="createdTime" column="created_time"/>
        <result property="fileName" column="file_name"/>
        <result property="fileDate" column="file_date"/>
        <result property="fileLength" column="file_length"/>
        <result property="fileContent" column="file_content" jdbcType="BINARY"/>
    </resultMap>

    <select id="findTemplateByUuid" resultMap="templateResultMap">
        SELECT uuid, path, version, type_id, status_id, description,
        created_by, created_time, file_name, file_date, file_length
        <if test="includeFileContent">
            , file_content
        </if>
        FROM process_template
        WHERE uuid = #{templateUuid}
    </select>

    <select id="findAllTemplates" resultMap="templateResultMap">
        SELECT uuid, path, version, type_id, status_id, description,
        created_by, created_time, file_name, file_date, file_length
        <if test="includeFileContent">
            , file_content
        </if>
        FROM process_template
    </select>

    <insert id="saveTemplate" flushCache="true">
        INSERT INTO process_template (uuid, path, version, type_id, status_id, description,
                                      created_by, created_time, file_name, file_date, file_length, file_content)
        VALUES (#{uuid},
                #{path},
                #{version},
                #{type, typeHandler=com.tesco.pma.dao.utils.DictionaryItemTypeHandler, jdbcType=INTEGER},
                #{status, typeHandler=com.tesco.pma.dao.utils.DictionaryItemTypeHandler, jdbcType=INTEGER},
                #{description},
                #{createdBy},
                #{createdTime},
                #{fileName},
                #{fileDate},
                #{fileLength},
                #{fileContent, javaType=byte[], jdbcType=BLOB, typeHandler=org.apache.ibatis.type.BlobTypeHandler})
    </insert>

    <select id="getMaxVersionForTemplate" resultType="int">
        SELECT COALESCE(MAX(version), 0) FROM process_template
        WHERE path = #{path} AND file_name = #{fileName}
    </select>

</mapper>